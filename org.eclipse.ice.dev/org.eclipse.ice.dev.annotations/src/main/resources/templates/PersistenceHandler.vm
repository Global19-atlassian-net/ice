## Declarations
#set($interface = "IPersistenceHandler")
##
#if($package)
package $package;
#end

import java.util.Map;
import java.util.UUID;

import org.bson.Document;
import org.eclipse.ice.dev.annotations.IDataElement;
import org.eclipse.ice.dev.annotations.IPersistenceHandler;
import org.eclipse.ice.dev.annotations.PersistenceFilters;

import com.fasterxml.jackson.core.JsonProcessingException;
import com.fasterxml.jackson.databind.ObjectMapper;
import com.mongodb.client.MongoCollection;
import com.mongodb.client.MongoDatabase;

/**
 * This is an implementation of $interface<$elementInterface>
 * that satisfies the dependencies of the {@code @Persisted} Annotation and was
 * auto-generated by the ICE Framework.
 */
public class $class implements $interface<$elementInterface> {

	/**
	 * The name of the collection backing this PersistenceHandler.
	 */
	private final static String COLLECTION = "$collection";

	/**
	 * The collection in which implementations of $elementInterface will be stored.
	 */
	private MongoCollection<Document> collection;

	/**
	 * Convert values from Document to $implementation using mapper.
	 */
	private ObjectMapper mapper = new ObjectMapper();

	public $class(MongoDatabase db) {
		this.collection = db.getCollection(COLLECTION);
	}

	/**
	 * Save the $elementInterface.
	 * @param <T> Object extending IDataElement
	 * @param element
	 * @throws Exception
	 */
	@Override
	public void save($elementInterface element) throws Exception {
		this.collection.insertOne(Document.parse(element.toJson()));
	}

	/**
	 * Find and retrieve all $elementInterface from the collection.
	 * @param <T>
	 * @return an iterable of the retrieved elements.
	 * @throws Exception
	 */
	@Override
	public Iterable<$elementInterface> findAll() throws Exception {
		return this.collection.find()
			.map(doc -> mapper.convertValue(doc, ${implementation}.class));
	}

	/**
	 * Clear all $elementInterface from the collection.
	 * @return
	 * @throws Exception
	 */
	@Override
	public long clear() throws Exception {
		long count = this.collection.count();
		this.collection.drop();
		return count;
	}

	#macro(findmethod $var $type $docName)
	#if(${var.Getter} && ${var.Search})
	#if(${var.Unique})

	/**
	 * Find $elementInterface by ${var.Name}.
	 * @param ${var.Name}
	 * @return found element or null
	 */
	#if(${var.DefaultField})
	@Override
	#end
	public $elementInterface findBy${var.NameForMethod}($type ${var.Name}) throws Exception {
		Document doc = this.collection
			.find(PersistenceFilters.eq("${docName}", ${var.Name}))
			.first();
		if (doc == null) {
			return null;
		}

		return mapper.convertValue(doc, ${implementation}.class);
	}
	#else

	/**
	 * Find $elementInterface by ${var.Name}.
	 * @param ${var.Name}
	 * @return Iterator of results
	 */
	#if(${var.DefaultField})
	@Override
	#end
	public Iterable<$elementInterface> findBy${var.NameForMethod}(${var.Type} ${var.Name}) throws Exception {
		return this.collection.find(PersistenceFilters.eq("${var.Name}", ${var.Name}))
			.map(doc -> mapper.convertValue(doc, ${implementation}.class));
	}
	#end## if unique
	#end## if getter and search
	#end## macro findmethod
	#foreach($field in $fields)
	#findmethod($field ${field.Type} ${field.Name})
	#foreach($alias in $field.Aliases)
	#findmethod($alias ${field.Type} ${field.Name})
	#end
	#end
}
